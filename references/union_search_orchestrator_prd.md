# Union Search 编排聚合方案（PRD + 技术实现文档）

## 1. 背景与问题

当前 `union_search` 已具备“多平台并发调用 + 汇总输出”能力，但在真实使用中出现以下核心问题：

1. 同一关键词下，`union_search` 的平台返回条数与“单独调用该平台脚本”不一致。
2. 聚合层对部分平台做了字段改写、结果裁剪或结构转换，导致与单模块原始输出不一致。
3. 聚合过程中存在“调用成功但结果为空/失真”的体验，难以判断是平台真实无结果还是聚合逻辑导致。
4. 用户目标是生成“全平台同关键词的一份聚合 JSON”，并要求可追溯、可校验、可对齐单模块结果。

因此需要明确技术选型：`union_search` 应转为**编排器（Orchestrator）**，而非“二次搜索器”。

## 2. 产品目标

### 2.1 核心目标

1. 对每个平台执行“与单独调用一致”的独立搜索请求。
2. 聚合层默认不改写平台结果内容，仅做统一封装与状态管理。
3. 输出一份可落盘的统一 JSON 文件，包含各平台原始结果、状态、错误、耗时等元信息。
4. 保证“单模块结果 == 聚合模块内该平台结果（在同参数、同时间窗口下）”。

### 2.2 非目标（本阶段不做）

1. 不在聚合层实现统一排序策略（跨平台 relevance 排序）。
2. 不实现跨平台去重功能（后续如需引入，单独评审设计）。
3. 不在本阶段统一各平台字段语义（仅透传，后续可选标准化层）。

## 3. 用户需求（根据沟通确认）

用户希望：

1. `union_search` 使用一个核心入口，统一调用所有平台模块。
2. 每个平台执行逻辑应等价于用户单独跑该平台脚本。
3. 最终返回“全平台聚合 JSON 文件”（文件输出为主，不依赖终端展示）。
4. 若某个平台失败，必须明确标记失败，不可混淆为“成功但空结果”。
5. 结果可核对：能验证聚合结果与单模块输出的一致性。

## 4. 方案概述

将 `union_search` 重构为三层：

1. **Platform Runner 层**：逐平台独立调用（CLI/API），每个平台作为黑盒执行。
2. **Orchestrator 层**：并发调度、超时控制、重试策略、错误收敛、结果汇总。
3. **Output Writer 层**：统一 JSON 落盘，输出运行摘要与平台明细。

设计原则：**黑盒调用、结果透传、状态显式、默认无损。**

## 5. 功能需求

### FR-1 平台独立调用一致性

1. 聚合层对平台传参与单独脚本调用参数保持一致（关键词、limit、分页、过滤条件）。
2. 聚合层默认返回平台原始结果数组，不进行二次字段改写。
3. 平台输出结构保留原字段（如 `link/href/url` 等不强制统一）。

### FR-2 状态与错误语义

每个平台必须输出如下状态字段：

1. `success=true`：调用成功且完成解析（即使结果为空，也需区分“真实空结果”）。
2. `success=false`：调用失败、超时、认证失败、解析失败等。
3. `error`：失败时提供可读错误信息（原始错误摘要）。
4. `total`：平台最终返回条数。

### FR-3 聚合 JSON 文件输出

输出结构至少包含：

1. 全局：`keyword`, `platforms`, `timestamp`, `summary`
2. 明细：`results.<platform>.{success,error,total,items,timing}`
3. `summary`：`total_platforms/successful/failed/total_items`

### FR-4 默认行为

1. 不执行跨平台去重。
2. 默认不做跨平台重排。
3. 默认输出 JSON（写入文件）。

### FR-5 可选后处理（可配置）

1. `--normalize`：显式开启字段标准化（后续迭代）。
2. `--strict-compare`：执行对照校验模式（见 FR-6）。

### FR-6 一致性校验能力

提供校验脚本/模式，自动对比：

1. 单独调用平台输出（基准）。
2. union 内该平台输出（同参数）。
3. 输出差异报告（条数差异、字段差异、内容差异）。

## 6. 非功能需求

1. 并发可控：`max_workers` 配置化。
2. 稳定性：单平台失败不影响全局聚合结果生成。
3. 可观测性：记录平台级耗时、失败原因、重试次数。
4. 输出可靠：文件写入原子性（建议临时文件 + rename）。
5. 向后兼容：保留现有 CLI 主入口，逐步迁移参数语义。

## 7. 数据契约（建议）

```json
{
  "keyword": "Python",
  "timestamp": "2026-02-26T21:45:00",
  "platforms": ["github", "reddit"],
  "summary": {
    "total_platforms": 2,
    "successful": 1,
    "failed": 1,
    "total_items": 10
  },
  "results": {
    "github": {
      "success": true,
      "error": null,
      "total": 10,
      "timing_ms": 820,
      "items": []
    },
    "reddit": {
      "success": false,
      "error": "403 forbidden",
      "total": 0,
      "timing_ms": 1040,
      "items": []
    }
  }
}
```

## 8. 关键技术决策

1. **编排优先**：union 不负责平台业务逻辑，只做调度与聚合。
2. **透传优先**：默认返回平台原始结构，避免聚合层引入语义偏差。
3. **失败显式化**：不允许“异常吞掉后返回空数组并标记成功”。
4. **暂不实现去重**：先保证结果一致性与可追溯性。
5. **输出文件优先**：以聚合 JSON 文件作为主交付物和审计依据。

## 9. 验收标准（UAT）

### AC-1 一致性

在同一关键词、同一参数下，抽样平台（至少 8 个）满足：

1. 条数一致（允许平台实时波动时配置时间窗口容忍）。
2. 第一条记录关键字段一致（id/url/title 等）。
3. 结构一致（是否保留原始字段命名）。

### AC-2 失败语义

当平台鉴权失败、超时、网络异常时：

1. 平台状态必须为 `success=false`。
2. `error` 必须非空，且可定位问题类型。

### AC-3 聚合文件可用性

1. 每次执行可稳定生成 JSON 文件。
2. 文件可被标准 JSON 解析器直接解析。
3. `summary` 与 `results` 条目一致。

## 10. 实施计划（建议）

### Phase 1（已开始）

1. 修正失败标记语义。
2. 移除当前实现中的去重能力与相关参数。
3. 修复明显的适配结构错配（如 twitter/zhihu）。

### Phase 2

1. 建立 `strict-compare` 对照工具。
2. 输出差异报告（Markdown + JSON）。
3. 梳理每个平台参数映射清单（防止调用参数不一致）。

### Phase 3

1. 可选标准化层（统一字段 schema）。
2. 可选后处理（重排、摘要）。
3. 增加回归测试矩阵（平台 x 参数组合）。

## 11. 风险与应对

1. 第三方接口实时波动导致“同分钟结果变化”。
   - 应对：校验时增加时间窗口与多次采样策略。
2. 平台限流/风控导致间歇失败。
   - 应对：指数退避重试 + 明确错误分类。
3. 平台脚本输出格式变更。
   - 应对：为每个平台添加契约测试（contract test）。

## 12. 待你确认的决策点

1. 是否将“默认输出格式”固定为 JSON 文件（终端仅打印摘要）？
2. 是否把“严格一致性（strict-compare）”作为发布前必跑检查？
3. 是否允许后续引入“标准化输出层”，但默认关闭？
